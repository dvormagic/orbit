name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]

    outputs:
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Check out git repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Read version
        id: meta
        shell: bash
        run: echo "version=$(node -p \"require('./package.json').version\")" >> "$GITHUB_OUTPUT"

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build (no publish)
        run: npm run build -- --publish never

      - name: Upload mac artifacts
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: orbit-macos
          if-no-files-found: error
          path: |
            release/${{ steps.meta.outputs.version }}/*.dmg
            release/${{ steps.meta.outputs.version }}/*.dmg.blockmap
            release/${{ steps.meta.outputs.version }}/latest-mac.yml

      - name: Upload windows artifacts
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: orbit-windows
          if-no-files-found: error
          path: |
            release/${{ steps.meta.outputs.version }}/*Windows*.exe
            release/${{ steps.meta.outputs.version }}/*Windows*.exe.blockmap
            release/${{ steps.meta.outputs.version }}/latest.yml

      - name: Upload linux artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: orbit-linux
          if-no-files-found: error
          path: |
            release/${{ steps.meta.outputs.version }}/*Linux*.AppImage
            release/${{ steps.meta.outputs.version }}/*Linux*.AppImage.blockmap
            release/${{ steps.meta.outputs.version }}/latest-linux.yml

  publish:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download mac artifacts
        uses: actions/download-artifact@v4
        with:
          name: orbit-macos
          path: dist/orbit-macos

      - name: Download windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: orbit-windows
          path: dist/orbit-windows

      - name: Download linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: orbit-linux
          path: dist/orbit-linux

      - name: Create GitHub Release (draft) and upload assets
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            dist/**/*
